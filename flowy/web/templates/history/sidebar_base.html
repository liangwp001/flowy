<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}执行历史{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/app.css') }}" rel="stylesheet">

    <style>
        /* 侧边栏模式的页面样式 */
        body {
            margin: 0;
            padding: 0;
            background: #f9fafb;
        }
        main.container-fluid {
            padding: 1.5rem;
            max-width: 100% !important;
        }
        /* 覆盖 history-modern.css 中的限制 */
        .content-wrapper {
            background: transparent !important;
            padding: 0 !important;
        }
        /* 隐藏不需要的元素 */
        .sidebar-mode-hide {
            display: none !important;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Main Content -->
    <main class="container-fluid">
        {% block content %}{% endblock %}
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

    <script>
        // 侧边栏模式：通知父窗口页面高度变化（带防抖和高度检查）
        let lastNotifiedHeight = 0;
        let notifyTimer = null;

        function notifyHeightChange() {
            if (window.parent === window) return;

            const height = document.body.offsetHeight;
            // 只有高度真正变化时才通知（避免循环）
            if (Math.abs(height - lastNotifiedHeight) > 10) {
                lastNotifiedHeight = height;
                window.parent.postMessage({
                    type: 'heightChange',
                    height: height
                }, '*');
            }
        }

        // 防抖版本的通知
        function notifyHeightChangeDebounced() {
            if (notifyTimer) clearTimeout(notifyTimer);
            notifyTimer = setTimeout(notifyHeightChange, 100);
        }

        // 侧边栏模式：处理详情链接点击，在新标签页打开
        function openDetailInNewTab(url) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'navigateToDetail',
                    url: url
                }, '*');
            } else {
                window.location.href = url;
            }
        }

        // 侧边栏模式：触发Flow后通知父窗口刷新
        function notifyFlowTriggered() {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'triggerFlow'
                }, '*');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始通知（延迟确保内容加载完成）
            setTimeout(notifyHeightChange, 100);
            setTimeout(notifyHeightChange, 300);
        });

        // 监听来自父窗口的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'sidebarMode') {
                console.log('Running in sidebar mode');
            }
        });

        // 当用户操作（点击、输入等）可能导致布局变化时，检查高度
        document.addEventListener('click', notifyHeightChangeDebounced, true);
        document.addEventListener('input', notifyHeightChangeDebounced, true);
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
