{# 侧边栏模式：检测 in_sidebar 参数 #}
{% set in_sidebar = request.args.get('in_sidebar') == '1' %}

{% if not in_sidebar %}
{# 正常模式：继承完整的 base.html #}
{% extends "base.html" %}
{% else %}
{# 侧边栏模式：使用简化的基础模板 #}
{% extends "history/sidebar_base.html" %}
{% endif %}

{% if in_sidebar %}
{# 侧边栏模式下的额外样式 #}
{% block extra_head_styles %}
<style>
    /* 侧边栏模式：移除页面滚动，让外层容器控制滚动 */
    html, body {
        overflow: hidden !important;
        height: auto !important;
        min-height: 0 !important;
    }
    
    .content-wrapper {
        overflow: visible !important;
        height: auto !important;
        min-height: 0 !important;
    }
    
    .container-fluid {
        overflow: visible !important;
        height: auto !important;
    }
</style>
{% endblock %}
{% endif %}

{% block title %}{{ flow.name }} - 执行历史 - Flowy管理系统{% endblock %}

{% set breadcrumb_items = [
    {'title': 'Flowy管理系统', 'url': url_for('flows.list_flows'), 'icon': 'bi-diagram-3'},
    {'title': 'Flow列表', 'url': url_for('flows.list_flows'), 'icon': 'bi-list-ul'},
    {'title': flow.name, 'url': url_for('flows.flow_detail', flow_id=flow.id), 'icon': 'bi-info-circle'},
    {'title': '执行历史', 'url': None, 'icon': 'bi-clock-history'}
] %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/history-modern.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/json-viewer.css') }}">
<style>
/* 页面特定样式 */
/* 确保5个卡片在一行展示 */
.stats-container {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

/* 合并后的统计卡片样式 */
.stat-card-main {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.stat-left {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-left .stat-icon {
    width: 48px;
    height: 48px;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
}

.stat-left .stat-icon.primary {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
}

.stat-left .stat-icon.success {
    background: linear-gradient(135deg, #10b981, #059669);
}

.stat-left .stat-icon.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.stat-left .stat-icon.info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.stat-left .stat-icon.secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
}

.stat-left .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #111827;
    line-height: 1;
}

.stat-trend {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 2rem;
    background: #f3f4f6;
    color: #6b7280;
}

.stat-trend.up {
    background: #d1fae5;
    color: #065f46;
}

.stat-trend.down {
    background: #fee2e2;
    color: #991b1b;
}

/* 表格视图切换器 */
.view-switcher {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: white;
    border-radius: 0.75rem;
    box-shadow: var(--card-shadow);
}

.view-toggle-group {
    display: flex;
    gap: 0.5rem;
}

.view-toggle-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
}

.view-toggle-btn:hover {
    background: #f9fafb;
}

.view-toggle-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.table-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.table-info {
    font-size: 0.875rem;
    color: #6b7280;
}

.export-btn {
    padding: 0.5rem 1rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.export-btn:hover {
    background: var(--primary-dark);
}

.btn-batch-delete {
    padding: 0.5rem 1rem;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-batch-delete:hover {
    background: #dc2626;
}

/* 现代化表格样式 */
.modern-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

.modern-table thead {
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
}

.modern-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: #374151;
    white-space: nowrap;
}

.modern-table tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background-color 0.2s ease;
}

.modern-table tbody tr:hover {
    background: #f9fafb;
}

.modern-table td {
    padding: 1rem;
    font-size: 0.875rem;
    color: #1f2937;
}

/* 状态徽章 */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}

.status-badge.pending {
    background: #f3f4f6;
    color: #374151;
}

.status-badge.running {
    background: #dbeafe;
    color: #1e40af;
}

.status-badge.completed {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.failed {
    background: #fee2e2;
    color: #991b1b;
}

/* 触发方式徽章 */
.trigger-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
}

.trigger-badge.trigger-manual {
    background: #e0e7ff;
    color: #4338ca;
}

.trigger-badge.trigger-scheduled {
    background: #fef3c7;
    color: #92400e;
}

/* 操作按钮组 */
.action-group {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 0.375rem;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.action-btn:hover {
    background: #f3f4f6;
    color: #374151;
    text-decoration: none;
}

.action-btn.delete-btn:hover {
    background: #fee2e2;
    color: #dc2626;
    border-color: #ef4444;
}

.data-preview-btn {
    padding: 0.25rem 0.75rem;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
}

.data-preview-btn:hover {
    background: #e5e7eb;
}

/* 加载动画 */
.animate-fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 响应式设计 */
@media (max-width: 1200px) {
    .stats-container {
        grid-template-columns: repeat(3, 1fr);
    }
}

@media (max-width: 768px) {
    .stats-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .view-switcher {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .modern-table {
        font-size: 0.8rem;
    }

    .modern-table th,
    .modern-table td {
        padding: 0.75rem 0.5rem;
    }

    .stat-left .stat-value {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .stats-container {
        grid-template-columns: 1fr;
    }
}

/* 展开/折叠功能样式 */
.expandable-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.expandable-row:hover {
    background-color: #f9fafb;
}

.expandable-row .expand-icon {
    transition: transform 0.3s ease;
    display: inline-block;
    width: 16px;
    height: 16px;
    color: #6b7280;
}

.expandable-row.expanded .expand-icon {
    transform: rotate(90deg);
}

.task-detail-row {
    display: none;
    background-color: #f8fafc;
}

.task-detail-row.visible {
    display: table-row;
}

.task-detail-cell {
    padding: 0 !important;
}

.task-list-container {
    padding: 1rem;
}

.task-list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.task-list-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-list-count {
    background: #e5e7eb;
    color: #6b7280;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
}

.task-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    transition: all 0.2s ease;
}

.task-item:hover {
    border-color: #d1d5db;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.task-item:last-child {
    margin-bottom: 0;
}

.task-item-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-right: 0.75rem;
}

.task-item-status.pending {
    background: #9ca3af;
}

.task-item-status.running {
    background: #3b82f6;
    animation: pulse 1.5s infinite;
}

.task-item-status.completed {
    background: #10b981;
}

.task-item-status.failed {
    background: #ef4444;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.task-item-content {
    flex: 1;
    min-width: 0;
}

.task-item-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-item-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-top: 0.25rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.task-item-time {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.task-item-duration {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.task-item-progress {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.task-progress-mini {
    width: 60px;
    height: 4px;
    background: #e5e7eb;
    border-radius: 2px;
    overflow: hidden;
}

.task-progress-mini-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #6366f1);
    border-radius: 2px;
    transition: width 0.3s ease;
}

.task-item-actions {
    display: flex;
    gap: 0.5rem;
    margin-left: 1rem;
}

.task-action-btn {
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 0.375rem;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.75rem;
}

.task-action-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.task-list-loading {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
    font-size: 0.875rem;
}

.task-list-empty {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
    font-size: 0.875rem;
}

.task-list-error {
    text-align: center;
    padding: 1.5rem;
    background: #fee2e2;
    color: #991b1b;
    border-radius: 0.5rem;
    font-size: 0.875rem;
}

/* ============================================
   当前任务列样式
=========================================== */
.current-task-cell {
    padding: 0.5rem 0;
}

.current-task-item {
    padding: 0.5rem 0;
}

.current-task-item:not(:last-child) {
    padding-bottom: 0.75rem;
    margin-bottom: 0.5rem;
    border-bottom: 1px dashed #e5e7eb;
}

.task-name {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #1f2937;
    margin-bottom: 0.375rem;
}

.task-icon {
    font-size: 0.75rem;
}

.task-icon.running {
    color: #3b82f6;
}

.task-icon.completed {
    color: #10b981;
}

.task-icon.failed {
    color: #ef4444;
}

.task-icon.pending {
    color: #9ca3af;
}

.task-progress-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 0.25rem;
}

.task-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #6366f1);
    border-radius: 3px;
    transition: width 0.3s ease;
}

.task-progress-fill.animated {
    background: linear-gradient(90deg, #3b82f6, #6366f1, #3b82f6);
    background-size: 200% 100%;
    animation: progressShimmer 1.5s infinite;
}

@keyframes progressShimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.task-progress-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
}

.task-progress-percent {
    font-weight: 600;
    color: #3b82f6;
}

.task-progress-message {
    color: #9ca3af;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-running-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #6b7280;
}

.task-running-indicator .spinner {
    width: 12px;
    height: 12px;
    border: 2px solid #e5e7eb;
    border-top-color: #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.no-current-task {
    color: #9ca3af;
    font-size: 0.875rem;
}

/* ============================================
   时间信息列样式
=========================================== */
.time-info-cell {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.5rem 0;
}

.time-info-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
}

.time-label {
    color: #9ca3af;
    font-weight: 500;
    min-width: 32px;
}

.time-value {
    color: #4b5563;
}

/* ============================================
   备注列样式
=========================================== */
.remark-cell {
    text-align: center;
}

.remark-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.remark-badge:hover {
    transform: scale(1.1);
}

.remark-badge .remark-count {
    position: absolute;
    top: -4px;
    right: -4px;
    min-width: 16px;
    height: 16px;
    padding: 0 4px;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.remark-badge.info {
    background: #d1fae5;
    color: #059669;
}

.remark-badge.info .remark-count {
    background: #10b981;
}

.remark-badge.warning {
    background: #fef3c7;
    color: #d97706;
}

.remark-badge.warning .remark-count {
    background: #f59e0b;
}

.remark-badge.error {
    background: #fee2e2;
    color: #dc2626;
}

.remark-badge.error .remark-count {
    background: #ef4444;
}

.remark-empty {
    color: #d1d5db;
    font-size: 1.125rem;
}

/* 备注模态框样式 */
.remark-modal-item {
    display: flex;
    align-items: flex-start;
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.remark-modal-item:last-child {
    border-bottom: none;
}

.remark-level-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.625rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    flex-shrink: 0;
}

.remark-level-badge.info {
    background: #d1fae5;
    color: #065f46;
}

.remark-level-badge.warning {
    background: #fef3c7;
    color: #92400e;
}

.remark-level-badge.error {
    background: #fee2e2;
    color: #991b1b;
}

.remark-content {
    flex: 1;
    margin-left: 0.75rem;
}

.remark-message {
    font-size: 0.875rem;
    color: #1f2937;
    margin-bottom: 0.25rem;
}

.remark-time {
    font-size: 0.75rem;
    color: #9ca3af;
}
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="container-fluid">

        
        <!-- 统计卡片 -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-card-main">
                    <div class="stat-left">
                        <div class="stat-icon primary">
                            <i class="bi bi-diagram-3"></i>
                        </div>
                        <div class="stat-value">{{ stats.total_count or 0 }}</div>
                    </div>
                    <div class="stat-trend up">
                        <i class="bi bi-arrow-up"></i>
                        <span>12%</span>
                    </div>
                </div>
                <div class="stat-label">总执行次数</div>
                <div class="stat-footer">最近7天平均执行 {{ (stats.total_count // 7) if stats.total_count else 0 }} 次</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-main">
                    <div class="stat-left">
                        <div class="stat-icon success">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="stat-value">{{ stats.success_count }}</div>
                    </div>
                    <div class="stat-trend up">
                        <i class="bi bi-arrow-up"></i>
                        <span>8%</span>
                    </div>
                </div>
                <div class="stat-label">成功次数</div>
                <div class="stat-footer">成功率 {{ stats.success_rate }}%</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-main">
                    <div class="stat-left">
                        <div class="stat-icon danger">
                            <i class="bi bi-x-circle"></i>
                        </div>
                        <div class="stat-value">{{ stats.failed_count }}</div>
                    </div>
                    <div class="stat-trend down">
                        <i class="bi bi-arrow-down"></i>
                        <span>3%</span>
                    </div>
                </div>
                <div class="stat-label">失败次数</div>
                <div class="stat-footer">失败率 {{ 100 - stats.success_rate }}%</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-main">
                    <div class="stat-left">
                        <div class="stat-icon warning">
                            <i class="bi bi-arrow-repeat"></i>
                        </div>
                        <div class="stat-value">{{ stats.running_count }}</div>
                    </div>
                    <div class="stat-trend">
                        <i class="bi bi-dash"></i>
                        <span>实时</span>
                    </div>
                </div>
                <div class="stat-label">正在运行</div>
                <div class="stat-footer">平均执行时长 {{ stats.avg_duration or 2.5 }} 分钟</div>
            </div>

            <div class="stat-card">
                <div class="stat-card-main">
                    <div class="stat-left">
                        <div class="stat-icon secondary">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="stat-value">{{ stats.pending_count }}</div>
                    </div>
                    <div class="stat-trend">
                        <i class="bi bi-dash"></i>
                        <span>等待</span>
                    </div>
                </div>
                <div class="stat-label">等待执行</div>
                <div class="stat-footer">平均等待时长 {{ stats.avg_wait_time }} 分钟</div>
            </div>
        </div>

        <!-- 筛选器 -->
        <div class="filter-section">
            <div class="filter-header">
                <h3 class="filter-title">
                    <i class="bi bi-funnel"></i>
                    筛选条件
                </h3>
                <div class="filter-header-controls">
                    <!-- 自动刷新开关 -->
                    <div class="auto-refresh-control">
                        <label class="auto-refresh-switch">
                            <input type="checkbox" id="autoRefreshToggle">
                            <span class="auto-refresh-slider"></span>
                        </label>
                        <span class="auto-refresh-label">
                            <i class="bi bi-arrow-clockwise"></i>
                            自动刷新
                        </span>
                        <span class="auto-refresh-status" id="autoRefreshStatus"></span>
                    </div>
                    <button class="filter-toggle" onclick="toggleFilter()">
                        <i class="bi bi-chevron-up" id="filterToggleIcon"></i>
                    </button>
                </div>
            </div>

            <div id="filterContent">
                <form method="GET" action="{{ url_for('flows.flow_history', flow_id=flow.id) }}" class="filter-form">
                    {% if in_sidebar %}
                    <input type="hidden" name="in_sidebar" value="1">
                    {% endif %}
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-flag"></i>
                            执行状态
                        </label>
                        <select class="filter-input" id="status" name="status">
                            <option value="">全部状态</option>
                            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>等待中</option>
                            <option value="running" {% if status_filter == 'running' %}selected{% endif %}>运行中</option>
                            <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>已完成</option>
                            <option value="failed" {% if status_filter == 'failed' %}selected{% endif %}>失败</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="bi bi-calendar-range"></i>
                            时间范围
                        </label>
                        <div class="date-range-group">
                            <input type="date" class="filter-input" name="start_date"
                                   value="{{ request.args.get('start_date', '') }}">
                            <span class="date-separator">至</span>
                            <input type="date" class="filter-input" name="end_date"
                                   value="{{ request.args.get('end_date', '') }}">
                        </div>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="btn-filter btn-filter-primary">
                            <i class="bi bi-funnel"></i>
                            应用筛选
                        </button>
                        <a href="{{ url_for('flows.flow_history', flow_id=flow.id) }}" class="btn-filter btn-filter-secondary">
                            <i class="bi bi-arrow-clockwise"></i>
                            重置
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- 执行历史表格 -->
        {% if histories %}
        <div class="table-section animate-fade-in">
            <div class="view-switcher">
                <div class="view-toggle-group">
                    <button class="view-toggle-btn active">
                        <i class="bi bi-list-columns"></i>
                        列表视图
                    </button>
                </div>
                <div class="table-actions">
                    <span class="table-info">已选择 <strong id="selectedCount">0</strong> 条记录</span>
                    <button class="btn-batch-delete" id="batchDeleteBtn" onclick="batchDeleteHistories()" style="display: none;">
                        <i class="bi bi-trash"></i>
                        批量删除
                    </button>
                    <button class="export-btn" onclick="exportData()">
                        <i class="bi bi-download"></i>
                        导出
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="modern-table" id="historyTable">
                    <thead>
                        <tr>
                            <th width="50">
                                <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th width="40"></th>
                            <th width="80">ID</th>
                            <th width="100">状态</th>
                            <th width="200">当前任务</th>
                            <th width="160">时间信息</th>
                            <th width="80">触发方式</th>
                            <th width="100">执行时长</th>
                            <th width="60">备注</th>
                            <th width="70">输入</th>
                            <th width="70">输出</th>
                            <th width="150">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in histories %}
                        <tr class="expandable-row" data-history-id="{{ history.id }}" onclick="toggleRowExpand({{ history.id }}, event)">
                            <td onclick="event.stopPropagation()">
                                <input type="checkbox" class="form-check-input row-checkbox" value="{{ history.id }}" onchange="updateSelectedCount()">
                            </td>
                            <td>
                                <i class="bi bi-chevron-right expand-icon"></i>
                            </td>
                            <td>
                                <span style="font-weight: 600; color: #6b7280;">#{{ history.id }}</span>
                            </td>
                            <td>
                                <span class="status-badge {{ history.status }}">
                                    <i class="bi bi-{% if history.status == 'pending' %}clock{% elif history.status == 'running' %}arrow-repeat{% elif history.status == 'completed' %}check-circle{% elif history.status == 'failed' %}x-circle{% else %}question-circle{% endif %}"></i>
                                    {{ '等待中' if history.status == 'pending' else ('运行中' if history.status == 'running' else ('已完成' if history.status == 'completed' else ('失败' if history.status == 'failed' else history.status))) }}
                                </span>
                            </td>
                            <td>
                                <div class="current-task-cell" data-history-id="{{ history.id }}">
                                    {% if history.status == 'running' and history.running_tasks %}
                                        {% for task in history.running_tasks %}
                                        <div class="current-task-item">
                                            <div class="task-name">
                                                <i class="bi bi-gear-fill task-icon running"></i>
                                                <span>{{ task.name }}</span>
                                            </div>
                                            {% if task.progress is not none %}
                                            <div class="task-progress-bar">
                                                <div class="task-progress-fill animated" style="width: {{ task.progress }}%"></div>
                                            </div>
                                            <div class="task-progress-info">
                                                <span class="task-progress-percent">{{ task.progress }}%</span>
                                                {% if task.progress_message %}
                                                <span class="task-progress-message">{{ task.progress_message }}</span>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <div class="task-running-indicator">
                                                <span class="spinner"></span>
                                                <span>执行中...</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    {% elif history.running_tasks %}
                                        {# 非运行状态，显示最后一个任务 #}
                                        {% for task in history.running_tasks %}
                                        <div class="current-task-item completed">
                                            <div class="task-name">
                                                <i class="bi bi-{% if task.status == 'completed' %}check-circle-fill{% elif task.status == 'failed' %}x-circle-fill{% else %}gear-fill{% endif %} task-icon {{ task.status }}"></i>
                                                <span>{{ task.name }}</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <span class="no-current-task">-</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="time-info-cell">
                                    <div class="time-info-row">
                                        <span class="time-label">创建</span>
                                        <span class="time-value">{{ history.created_at|datetime }}</span>
                                    </div>
                                    {% if history.start_time %}
                                    <div class="time-info-row">
                                        <span class="time-label">开始</span>
                                        <span class="time-value">{{ history.start_time|datetime }}</span>
                                    </div>
                                    {% endif %}
                                    {% if history.end_time %}
                                    <div class="time-info-row">
                                        <span class="time-label">结束</span>
                                        <span class="time-value">{{ history.end_time|datetime }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if history.trigger_name %}
                                    <span class="trigger-badge trigger-scheduled" title="触发器: {{ history.trigger_name }}">
                                        <i class="bi bi-clock-history"></i>
                                        {{ history.trigger_name }}
                                    </span>
                                {% else %}
                                    <span class="trigger-badge trigger-manual" title="手动触发">
                                        <i class="bi bi-hand-index-thumb"></i>
                                        手动
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span style="color: #6b7280;" class="duration-cell"
                                      {% if history.status == 'running' and history.start_time %}
                                      data-start-time="{{ history.start_time.timestamp() }}"
                                      data-is-running="true"
                                      {% endif %}>
                                    <i class="bi bi-clock-history"></i>
                                    <span class="duration-text">{{ history.start_time|duration(history.end_time) }}</span>
                                </span>
                            </td>
                            <td onclick="event.stopPropagation()" class="remark-cell">
                                {% if history.remarks %}
                                    <div class="remark-badge {{ history.remark_level }}"
                                             onclick="viewRemarks({{ history.id }})"
                                             data-history-id="{{ history.id }}"
                                             data-remarks='{{ history.remarks|tojson|e }}'>
                                        <i class="bi bi-chat-dots"></i>
                                        <span class="remark-count">{{ history.remarks|length }}</span>
                                    </div>
                                {% else %}
                                    <span class="remark-empty"><i class="bi bi-chat-dots"></i></span>
                                {% endif %}
                            </td>
                            <td onclick="event.stopPropagation()">
                                {% if history.input_data %}
                                    <button type="button" class="data-preview-btn view-data-btn"
                                            data-title="输入数据"
                                            data-data='{{ history.input_data|tojson|e }}'>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            </td>
                            <td onclick="event.stopPropagation()">
                                {% if history.output_data %}
                                    <button type="button" class="data-preview-btn view-data-btn"
                                            data-title="输出数据"
                                            data-data='{{ history.output_data|tojson|e }}'>
                                        <i class="bi bi-eye"></i>
                                    </button>
                                {% else %}
                                    <span style="color: #9ca3af;">-</span>
                                {% endif %}
                            </td>
                            <td onclick="event.stopPropagation()">
                                <div class="action-group">
                                    <a href="{{ url_for('flows.history_detail', history_id=history.id) }}"
                                       class="action-btn" data-tooltip="查看详情" target="_blank" rel="noopener">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <button class="action-btn log-btn" data-tooltip="查看执行日志"
                                            data-history-id="{{ history.id }}"
                                            onclick="viewHistoryLogs({{ history.id }})">
                                        <i class="bi bi-file-text"></i>
                                    </button>
                                    <button class="action-btn retry-btn" data-tooltip="使用相同参数重新执行"
                                            data-flow-id="{{ flow.id }}"
                                            data-history-id="{{ history.id }}"
                                            data-input-data='{{ history.input_data|tojson|e }}'>
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    <button class="action-btn delete-btn" data-tooltip="删除"
                                            onclick="deleteHistory({{ history.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr class="task-detail-row" data-detail-for="{{ history.id }}">
                            <td colspan="12" class="task-detail-cell">
                                <div class="task-list-container" id="taskList-{{ history.id }}">
                                    <div class="task-list-loading">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">加载任务列表...</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 分页 -->
        {% from 'components/pagination.html' import pagination %}
        <div class="pagination-wrapper">
            <div class="pagination-info">
                显示第 {{ (current_page - 1) * 30 + 1 }} - {{ (current_page * 30 if current_page * 30 < total_count else total_count) }} 条，共 {{ total_count }} 条记录
            </div>
            {{ pagination(current_page, total_pages, 'flows.flow_history', flow_id=flow.id, status=status_filter, in_sidebar=in_sidebar) }}
        </div>

        {% else %}
        <!-- 空状态 -->
        <div class="empty-state animate-fade-in">
            <div class="empty-state-icon">
                <i class="bi bi-inbox"></i>
            </div>
            <h3>
                {% if status_filter or request.args.get('start_date') or request.args.get('end_date') %}
                    没有找到符合筛选条件的执行记录
                {% else %}
                    该Flow还没有执行记录
                {% endif %}
            </h3>
            <p>
                {% if status_filter or request.args.get('start_date') or request.args.get('end_date') %}
                    请尝试调整筛选条件，或查看所有记录
                {% else %}
                    执行您的第一个工作流后，执行记录将显示在这里
                {% endif %}
            </p>
            <div class="empty-state-actions">
                {% if status_filter or request.args.get('start_date') or request.args.get('end_date') %}
                    <a href="{{ url_for('flows.flow_history', flow_id=flow.id) }}" class="btn-filter btn-filter-primary">
                        <i class="bi bi-grid"></i>
                        查看所有记录
                    </a>
                {% else %}
                    <button type="button" class="btn-filter btn-filter-primary" onclick="triggerFlow('{{ flow.id }}')">
                        <i class="bi bi-play-circle"></i>
                        立即执行
                    </button>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- 数据预览模态框 -->
<div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="json-container">
                    <div class="json-viewer" id="modal-data-viewer"></div>
                </div>
                <!-- 隐藏的原始数据用于复制 -->
                <textarea id="modal-data-textarea" style="display: none;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="copyModalData(event)">
                    <i class="bi bi-clipboard"></i> 复制到剪贴板
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 加载遮罩（初始隐藏） -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
</div>

<!-- 参数输入模态框 -->
<div class="modal fade" id="triggerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-play-circle"></i>
                    触发Flow执行
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="flowId" class="form-label">Flow ID</label>
                    <input type="text" class="form-control" id="flowId" readonly>
                </div>

                <div class="mb-3">
                    <label for="flowParams" class="form-label">
                        <i class="bi bi-code-slash"></i>
                        执行参数 (JSON格式)
                    </label>
                    <textarea class="form-control font-monospace" id="flowParams" rows="8"
                              placeholder='输入JSON格式的参数，例如：

【完整参数格式】
{
  "args": ["参数1", "参数2"],
  "kwargs": {
    "key1": "value1",
    "key2": "value2"
  }
}

【单个对象参数】（适用于data_processing等工作流）
{
  "items": [1, 2, 3, 4, 5],
  "metadata": {"source": "test"}
}

【简单参数】
"简单字符串参数"

或者数字：12345'></textarea>
                </div>

                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>参数说明：</strong>
                    <ul class="mb-0 mt-2">
                        <li><strong>完整格式</strong>: <code>{"args": [...], "kwargs": {...}}</code> - 明确指定位置和关键字参数</li>
                        <li><strong>对象格式</strong>: 直接传入JSON对象，作为第一个位置参数（适用于数据处理类工作流）</li>
                        <li><strong>简单格式</strong>: 字符串、数字等简单值，作为单个位置参数</li>
                        <li><strong>留空</strong>: 不传递任何参数</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmTrigger">
                    <i class="bi bi-play-circle"></i>
                    确认执行
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 日志查看模态框 -->
<div class="modal fade" id="logModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text"></i>
                    执行日志 #<span id="log-history-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="log-content-container">
                    <div class="text-center" style="padding: 2rem;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2">正在加载日志...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="refreshHistoryLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                    刷新
                </button>
                <button type="button" class="btn btn-primary" onclick="copyHistoryLogs()">
                    <i class="bi bi-clipboard"></i>
                    复制日志
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 备注查看模态框 -->
<div class="modal fade" id="remarkModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-chat-dots"></i>
                    执行备注 #<span id="remark-history-id"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="remark-content-container">
                    <!-- 备注列表将在这里渲染 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/json-viewer.js') }}"></script>
<script>
// 全局变量存储当前查看的日志
let currentHistoryId = null;
let currentLogContent = '';

// 查看历史记录日志
function viewHistoryLogs(historyId) {
    currentHistoryId = historyId;
    document.getElementById('log-history-id').textContent = historyId;
    
    const modal = new bootstrap.Modal(document.getElementById('logModal'));
    modal.show();
    
    // 加载日志内容
    loadHistoryLogs(historyId);
}

// 加载日志内容
function loadHistoryLogs(historyId) {
    const container = document.getElementById('log-content-container');
    container.innerHTML = `
        <div class="text-center" style="padding: 2rem;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载日志...</p>
        </div>
    `;
    
    fetch(`/api/history/${historyId}/logs`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentLogContent = data.data.log_content;
                
                if (currentLogContent.trim()) {
                    // 显示日志内容
                    container.innerHTML = `
                        <div style="background: #1e1e1e; color: #d4d4d4; padding: 1.5rem; border-radius: 0.5rem; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.875rem; line-height: 1.6; max-height: 600px; overflow-y: auto;">
                            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(currentLogContent)}</pre>
                        </div>
                        <div class="mt-3 text-muted" style="font-size: 0.875rem;">
                            <i class="bi bi-info-circle"></i>
                            日志文件: ${data.data.log_file}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            日志文件为空或尚未生成日志内容
                        </div>
                    `;
                }
            } else {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        ${data.error || '无法加载日志文件'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('加载日志失败:', error);
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i>
                    加载日志失败: ${error.message}
                </div>
            `;
        });
}

// 刷新日志
function refreshHistoryLogs() {
    if (currentHistoryId) {
        loadHistoryLogs(currentHistoryId);
        showNotification('日志已刷新', 'success');
    }
}

// 复制日志
function copyHistoryLogs() {
    if (!currentLogContent) {
        showNotification('没有可复制的日志内容', 'warning');
        return;
    }

    // 方法1: 使用 Clipboard API (需要安全上下文)
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(currentLogContent).then(() => {
            showNotification('日志已复制到剪贴板', 'success');
        }).catch(err => {
            console.error('复制失败:', err);
            // 尝试备用方法
            fallbackCopyLog();
        });
        return;
    }

    // 方法2: 使用传统方法
    fallbackCopyLog();
}

// 备用日志复制方法
function fallbackCopyLog() {
    // 创建一个临时文本区域
    const textarea = document.createElement('textarea');
    textarea.value = currentLogContent;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);

    textarea.select();
    textarea.setSelectionRange(0, 999999); // 兼容移动端

    try {
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);

        if (successful) {
            showNotification('日志已复制到剪贴板', 'success');
        } else {
            showNotification('复制失败，请手动复制', 'error');
        }
    } catch (err) {
        document.body.removeChild(textarea);
        console.error('复制失败:', err);
        showNotification('复制失败，请手动复制', 'error');
    }
}

// ========================================
// 备注查看功能
// ========================================

/**
 * 查看执行历史备注
 */
function viewRemarks(historyId) {
    document.getElementById('remark-history-id').textContent = historyId;

    const container = document.getElementById('remark-content-container');

    // 尝试从DOM中获取备注数据（已由后端渲染）
    const badge = document.querySelector(`.remark-badge[data-history-id="${historyId}"]`);
    if (badge && badge.dataset.remarks) {
        try {
            const remarks = JSON.parse(badge.dataset.remarks);
            renderRemarks(remarks);
        } catch (e) {
            console.error('解析备注数据失败:', e);
            container.innerHTML = '<div class="alert alert-danger">解析备注数据失败</div>';
        }
    } else {
        // 如果DOM中没有，从API获取
        container.innerHTML = `
            <div class="text-center" style="padding: 2rem;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载备注...</p>
            </div>
        `;

        fetch(`/api/history/${historyId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data.flow_history) {
                    // 从 metadata 中解析备注
                    const metadata = JSON.parse(data.data.flow_history.flow_metadata || '{}');
                    const remarks = metadata.remarks || [];
                    renderRemarks(remarks);
                } else {
                    container.innerHTML = '<div class="alert alert-warning">暂无备注</div>';
                }
            })
            .catch(error => {
                console.error('加载备注失败:', error);
                container.innerHTML = '<div class="alert alert-danger">加载备注失败</div>';
            });
    }

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('remarkModal'));
    modal.show();
}

/**
 * 渲染备注列表
 */
function renderRemarks(remarks) {
    const container = document.getElementById('remark-content-container');

    if (!remarks || remarks.length === 0) {
        container.innerHTML = `
            <div class="text-center" style="padding: 2rem; color: #9ca3af;">
                <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                <p class="mt-2">暂无备注</p>
            </div>
        `;
        return;
    }

    let html = '<div class="remark-list">';

    remarks.forEach(remark => {
        const levelText = {
            'info': '信息',
            'warning': '警告',
            'error': '错误'
        }[remark.level] || remark.level;

        const iconClass = {
            'info': 'info-circle',
            'warning': 'exclamation-triangle',
            'error': 'x-circle'
        }[remark.level] || 'info-circle';

        html += `
            <div class="remark-modal-item">
                <span class="remark-level-badge ${remark.level}">
                    <i class="bi bi-${iconClass}"></i>
                    ${levelText}
                </span>
                <div class="remark-content">
                    <div class="remark-message">${escapeHtml(remark.message)}</div>
                    <div class="remark-time">${formatRemarkTime(remark.timestamp)}</div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

/**
 * 格式化备注时间
 */
function formatRemarkTime(isoString) {
    if (!isoString) return '';

    const date = new Date(isoString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// HTML转义函数
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 筛选器展开/收起
function toggleFilter() {
    const content = document.getElementById('filterContent');
    const icon = document.getElementById('filterToggleIcon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// 查看数据
function viewData(data, title) {
    try {
        // 解析JSON数据（现在后端已经解析过了，只需要一次解析）
        const jsonData = JSON.parse(data);

        // 设置模态框标题
        document.querySelector('#dataModal .modal-title').textContent = title;

        // 设置隐藏的文本区域用于复制
        document.getElementById('modal-data-textarea').value = JSON.stringify(jsonData, null, 2);

        // 创建JSON Viewer实例并渲染数据
        const viewer = new JSONViewer({
            rootCollapsable: true,
            clickableUrls: true,
            bigNumbers: false
        });
        const viewerElement = document.getElementById('modal-data-viewer');
        viewer.render(viewerElement, jsonData);

        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        modal.show();

    } catch (e) {
        console.error('解析JSON数据失败:', e);
        // 如果解析失败，使用原始的显示方式
        document.querySelector('#dataModal .modal-title').textContent = title;
        document.getElementById('modal-data-viewer').innerHTML = `<pre class="bg-light p-3 rounded"><code>${formatJSON(data)}</code></pre>`;
        document.getElementById('modal-data-textarea').value = data;

        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        modal.show();
    }
}

// 处理数据预览按钮点击事件
function handleDataPreviewClick(event) {
    const button = event.currentTarget;
    const title = button.dataset.title;
    const data = button.dataset.data;

    viewData(data, title);
}

// 复制数据
function copyModalData(event) {
    const textarea = document.getElementById('modal-data-textarea');
    const text = textarea.value;

    // 获取按钮元素
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;

    // 复制成功的回调函数
    const showSuccess = () => {
        button.innerHTML = '<i class="bi bi-check"></i> 已复制';
        button.classList.add('btn-success');
        button.classList.remove('btn-primary');

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-primary');
        }, 2000);
    };

    // 复制失败的回调函数
    const showError = (err) => {
        console.error('复制失败:', err);
        button.innerHTML = '<i class="bi bi-x"></i> 失败';
        button.classList.add('btn-danger');
        button.classList.remove('btn-primary');

        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-danger');
            button.classList.add('btn-primary');
        }, 2000);

        showNotification('复制失败，请手动复制', 'warning');
    };

    // 方法1: 使用 Clipboard API (需要安全上下文)
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(showSuccess).catch(showError);
        return;
    }

    // 方法2: 使用传统 execCommand 方法
    textarea.select();
    textarea.setSelectionRange(0, 999999); // 兼容移动端

    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showSuccess();
        } else {
            showError(new Error('execCommand 返回 false'));
        }
    } catch (err) {
        showError(err);
    }

    // 取消选中状态
    window.getSelection().removeAllRanges();
}

// 格式化JSON
function formatJSON(text) {
    try {
        const obj = JSON.parse(text);
        return JSON.stringify(obj, null, 2);
    } catch (e) {
        return text;
    }
}

// 触发Flow执行
function triggerFlow(flowId) {
    // 显示参数输入对话框
    showTriggerModal(flowId);
}

// 显示触发参数输入对话框
function showTriggerModal(flowId) {
    // 设置Flow ID
    document.getElementById('flowId').value = flowId;

    // 清空参数输入框
    document.getElementById('flowParams').value = '';

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('triggerModal'));
    modal.show();

    // 聚焦到参数输入框
    setTimeout(() => {
        document.getElementById('flowParams').focus();
    }, 500);
}

// 确认触发Flow
function confirmTriggerFlow() {
    const flowId = document.getElementById('flowId').value;
    const paramsText = document.getElementById('flowParams').value.trim();

    // 解析参数
    let inputData = {};

    if (paramsText) {
        try {
            // 尝试解析为JSON
            inputData = JSON.parse(paramsText);
        } catch (e) {
            // 如果不是JSON格式，作为简单字符串处理
            inputData = paramsText;
        }
    }

    // 包装成后端期望的格式
    const requestData = {
        input_data: inputData,
        metadata: {}
    };

    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('triggerModal'));
    modal.hide();

    // 显示加载状态
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    // 发送请求
    fetch(`/api/flows/${flowId}/run`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.style.display = 'none';
        if (data.success) {
            showNotification('Flow已成功触发执行！', 'success');
            // 延迟刷新页面以显示新的运行状态
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification('触发失败: ' + data.error, 'error');
        }
    })
    .catch(error => {
        loadingOverlay.style.display = 'none';
        console.error('Error:', error);
        showNotification('请求失败，请检查网络连接', 'error');
    });
}

// 验证JSON格式
function validateJSON(text) {
    try {
        JSON.parse(text);
        return { valid: true, error: null };
    } catch (e) {
        return { valid: false, error: e.message };
    }
}

// 显示通知
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;

    // 根据类型选择图标和颜色
    let iconClass = 'info-circle';
    let bgColor = '#3b82f6';

    if (type === 'success') {
        iconClass = 'check-circle';
        bgColor = '#10b981';
    } else if (type === 'error') {
        iconClass = 'x-circle';
        bgColor = '#ef4444';
    } else if (type === 'warning') {
        iconClass = 'exclamation-triangle';
        bgColor = '#f59e0b';
    }

    notification.innerHTML = `
        <div class="notification-content">
            <i class="bi bi-${iconClass}"></i>
            <span>${message}</span>
        </div>
    `;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${bgColor};
        color: white;
        border-radius: 0.75rem;
        box-shadow: var(--card-hover-shadow);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
    `;

    document.body.appendChild(notification);

    // 自动移除通知
    setTimeout(() => {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// ========================================
// 批量选择和删除功能
// ========================================

// 全选/取消全选
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    updateSelectedCount();
}

// 更新选中数量
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;

    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (count > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        batchDeleteBtn.textContent = `批量删除 (${count})`;
    } else {
        batchDeleteBtn.style.display = 'none';
    }
}

// 获取选中的历史记录ID
function getSelectedHistoryIds() {
    const checkboxes = document.querySelectorAll('.row-checkbox:checked');
    return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

// 单个删除历史记录
function deleteHistory(historyId) {
    if (!confirm(`确定要删除执行历史 #${historyId} 吗？删除后将无法恢复。`)) {
        return;
    }

    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    fetch(`/api/history/${historyId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.style.display = 'none';
        if (data.success) {
            showNotification(data.message || '删除成功', 'success');
            // 从表格中移除该行
            const row = document.querySelector(`tr[data-history-id="${historyId}"]`);
            if (row) {
                row.style.opacity = '0.5';
                setTimeout(() => {
                    row.remove();
                    // 检查是否还有数据
                    const tbody = document.querySelector('.modern-table tbody');
                    if (tbody && tbody.children.length === 0) {
                        location.reload();
                    }
                }, 300);
            }
        } else {
            showNotification('删除失败: ' + (data.error || '未知错误'), 'error');
        }
    })
    .catch(error => {
        loadingOverlay.style.display = 'none';
        console.error('删除失败:', error);
        showNotification('删除失败，请检查网络连接', 'error');
    });
}

// 批量删除历史记录
function batchDeleteHistories() {
    const historyIds = getSelectedHistoryIds();
    if (historyIds.length === 0) {
        showNotification('请先选择要删除的记录', 'error');
        return;
    }

    if (!confirm(`确定要删除选中的 ${historyIds.length} 条执行历史吗？删除后将无法恢复。`)) {
        return;
    }

    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    fetch('/api/history/batch-delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ history_ids: historyIds })
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.style.display = 'none';
        if (data.success) {
            showNotification(data.message || '批量删除成功', 'success');
            // 从表格中移除已删除的行
            historyIds.forEach(id => {
                const row = document.querySelector(`tr[data-history-id="${id}"]`);
                if (row) {
                    row.style.opacity = '0.5';
                    setTimeout(() => row.remove(), 300);
                }
            });
            // 重置全选框
            document.getElementById('selectAll').checked = false;
            updateSelectedCount();
            // 延迟刷新页面以更新统计数据
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            showNotification('批量删除失败: ' + (data.error || '未知错误'), 'error');
        }
    })
    .catch(error => {
        loadingOverlay.style.display = 'none';
        console.error('批量删除失败:', error);
        showNotification('批量删除失败，请检查网络连接', 'error');
    });
}

// 重新执行Flow
function rerunFlow(flowId) {
    triggerFlow(flowId);
}

// 处理重试按钮点击事件
function handleRetryButtonClick(event) {
    const button = event.currentTarget;
    const flowId = button.dataset.flowId;
    const historyId = button.dataset.historyId;
    const inputDataAttr = button.dataset.inputData;

    console.log('重试按钮点击 - Flow ID:', flowId);
    console.log('重试按钮点击 - History ID:', historyId);
    console.log('重试按钮点击 - 原始输入数据属性:', inputDataAttr);

    // 解析输入数据 - 现在只需要单次解析
    let originalInputData = null;
    if (inputDataAttr && inputDataAttr !== 'null' && inputDataAttr !== 'None' && inputDataAttr !== '') {
        try {
            originalInputData = JSON.parse(inputDataAttr);
            console.log('解析后的输入数据:', originalInputData);
        } catch (e) {
            console.error('解析输入数据失败:', e);
            console.log('使用原始字符串:', inputDataAttr);
            originalInputData = inputDataAttr;
        }
    } else {
        console.log('没有输入数据或数据为空');
    }

    // 调用重试函数
    retryFlowWithParams(flowId, historyId, originalInputData);
}

// 使用原始参数重新执行Flow
function retryFlowWithParams(flowId, historyId, originalInputData) {
    console.log('retryFlowWithParams 被调用');
    console.log('Flow ID:', flowId);
    console.log('History ID:', historyId);
    console.log('原始输入数据:', originalInputData);

    // 设置Flow ID
    document.getElementById('flowId').value = flowId;

    // 解析并设置原始输入数据
    let paramsText = '';
    if (originalInputData && originalInputData !== null && originalInputData !== undefined) {
        console.log('开始解析输入数据...');
        try {
            // 如果传入的已经是对象，直接使用；如果是字符串，先解析
            const inputData = typeof originalInputData === 'string' ? JSON.parse(originalInputData) : originalInputData;
            console.log('解析后的数据结构:', inputData);

            // 检查数据结构，支持三种格式：
            // 1. {"args": [arg1, arg2], "kwargs": {...}} - 完整参数格式
            // 2. {"args": {"__class__": "tuple", "__value__": [...]}, "kwargs": {...}} - 序列化格式
            // 3. {"a": 1, "b": 2} - 直接参数对象格式（后端存储的实际格式）

            let argsArray = null;
            let hasArgsKwargsFormat = false;

            if (inputData.args !== undefined) {
                hasArgsKwargsFormat = true;
                if (Array.isArray(inputData.args)) {
                    // 直接数组格式
                    argsArray = inputData.args;
                    console.log('发现直接数组格式的位置参数:', argsArray);
                } else if (inputData.args.__value__ && Array.isArray(inputData.args.__value__)) {
                    // 序列化格式
                    argsArray = inputData.args.__value__;
                    console.log('发现序列化格式的位置参数:', argsArray);
                }
            }

            if (hasArgsKwargsFormat) {
                // 使用 args/kwargs 格式
                if (argsArray && argsArray.length > 0) {
                    // 如果有位置参数
                    if (argsArray.length === 1 && (!inputData.kwargs || Object.keys(inputData.kwargs).length === 0)) {
                        // 只有一个位置参数，无关键字参数，显示简化格式
                        paramsText = JSON.stringify(argsArray[0], null, 2);
                        console.log('使用简化格式:', paramsText);
                    } else {
                        // 多个参数或有关键字参数，显示完整格式
                        paramsText = JSON.stringify({
                            args: argsArray,
                            kwargs: inputData.kwargs || {}
                        }, null, 2);
                        console.log('使用完整格式:', paramsText);
                    }
                } else if (inputData.kwargs && Object.keys(inputData.kwargs).length > 0) {
                    console.log('发现关键字参数:', inputData.kwargs);
                    // 只有关键字参数
                    paramsText = JSON.stringify({
                        kwargs: inputData.kwargs
                    }, null, 2);
                    console.log('使用关键字格式:', paramsText);
                } else {
                    console.log('args/kwargs格式但没有有效参数，使用空字符串');
                    paramsText = '';
                }
            } else if (typeof inputData === 'object' && inputData !== null && Object.keys(inputData).length > 0) {
                // 直接参数对象格式：{"a": 1, "b": 2}
                // 过滤掉内部元数据字段（如 _metadata）
                const filteredData = {};
                for (const key in inputData) {
                    if (!key.startsWith('_')) {
                        filteredData[key] = inputData[key];
                    }
                }

                if (Object.keys(filteredData).length > 0) {
                    paramsText = JSON.stringify(filteredData, null, 2);
                    console.log('使用直接参数对象格式:', paramsText);
                } else {
                    console.log('过滤后没有有效参数，使用空字符串');
                    paramsText = '';
                }
            } else {
                console.log('没有发现有效参数，使用空字符串');
                paramsText = '';
            }
        } catch (e) {
            console.error('解析原始输入数据失败:', e);
            // 如果解析失败，根据数据类型处理
            if (typeof originalInputData === 'object') {
                paramsText = JSON.stringify(originalInputData, null, 2);
            } else {
                paramsText = originalInputData;
            }
            console.log('使用回退格式:', paramsText);
        }
    } else {
        console.log('没有原始输入数据');
    }

    console.log('最终参数文本:', paramsText);

    // 设置参数值
    const flowParamsElement = document.getElementById('flowParams');
    if (flowParamsElement) {
        flowParamsElement.value = paramsText;
        console.log('参数已设置到输入框');
    } else {
        console.error('找不到 flowParams 元素');
    }

    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('triggerModal'));
    modal.show();

    // 聚焦到参数输入框并选中所有文本
    setTimeout(() => {
        const paramsInput = document.getElementById('flowParams');
        if (paramsInput) {
            paramsInput.focus();
            paramsInput.select();
            console.log('参数输入框已聚焦和选中');
        } else {
            console.error('找不到参数输入框元素');
        }
    }, 500);
}

// 导出数据功能
function exportData() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    // 构建导出URL
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');

    // 下载文件
    window.location.href = `{{ url_for('flows.flow_history', flow_id=flow.id) }}?${params.toString()}`;

    // 延迟隐藏加载遮罩
    setTimeout(() => {
        loadingOverlay.style.display = 'none';
    }, 2000);
}

// 自动刷新控制
let refreshInterval = null;
let isAutoRefreshEnabled = false;
// 为每个工作流使用独立的 localStorage key
const AUTO_REFRESH_STORAGE_KEY = 'flowy_history_auto_refresh_{{ flow.id }}';

function toggleAutoRefresh() {
    const toggle = document.getElementById('autoRefreshToggle');
    const status = document.getElementById('autoRefreshStatus');

    if (toggle.checked) {
        startAutoRefresh();
    } else {
        stopAutoRefresh();
    }
}

function startAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }

    isAutoRefreshEnabled = true;
    localStorage.setItem(AUTO_REFRESH_STORAGE_KEY, 'true');
    updateAutoRefreshStatus();

    refreshInterval = setInterval(() => {
        // 检查是否还有运行中的Flow
        fetch('/api/flows/running-count')
            .then(response => response.json())
            .then(data => {
                updateAutoRefreshStatus(data.count);
                // 即使没有运行中的Flow也继续刷新（用户手动控制）
            })
            .catch(error => {
                console.error('刷新失败:', error);
                updateAutoRefreshStatus(null, true);
            });

        // 刷新页面
        location.reload();
    }, 5000);
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
    isAutoRefreshEnabled = false;
    localStorage.setItem(AUTO_REFRESH_STORAGE_KEY, 'false');
    updateAutoRefreshStatus();
}

function updateAutoRefreshStatus(runningCount = null, hasError = false) {
    const status = document.getElementById('autoRefreshStatus');
    const toggle = document.getElementById('autoRefreshToggle');

    if (hasError) {
        status.textContent = ' (连接错误)';
        status.className = 'auto-refresh-status error';
    } else if (isAutoRefreshEnabled) {
        if (runningCount !== null) {
            status.textContent = ` (${runningCount > 0 ? runningCount + '个运行中' : '无运行中'})`;
            status.className = 'auto-refresh-status active';
        } else {
            status.textContent = ' (已启用)';
            status.className = 'auto-refresh-status active';
        }
    } else {
        status.textContent = ' (已停止)';
        status.className = 'auto-refresh-status inactive';
    }
}

// ========================================
// 运行中任务的实时时长更新
// ========================================

let durationUpdateInterval = null;

function formatDurationFromSeconds(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const remainder = totalSeconds % 3600;
    const minutes = Math.floor(remainder / 60);
    const seconds = remainder % 60;

    if (hours > 0) {
        return `${hours}小时${minutes}分${seconds}秒`;
    } else if (minutes > 0) {
        return `${minutes}分${seconds}秒`;
    } else {
        return `${seconds}秒`;
    }
}

function updateRunningDurations() {
    const runningCells = document.querySelectorAll('.duration-cell[data-is-running="true"]');

    runningCells.forEach(cell => {
        const startTime = parseFloat(cell.dataset.startTime);
        const now = Date.now() / 1000; // 转换为秒
        const elapsed = Math.floor(now - startTime);
        const durationText = cell.querySelector('.duration-text');

        if (durationText) {
            durationText.textContent = formatDurationFromSeconds(elapsed);
        }
    });
}

function initRunningDurationUpdate() {
    // 立即更新一次
    updateRunningDurations();

    // 每秒更新一次
    if (durationUpdateInterval) {
        clearInterval(durationUpdateInterval);
    }
    durationUpdateInterval = setInterval(updateRunningDurations, 1000);
}

// ========================================
// 展开/折叠功能
// ========================================

// 存储已加载的任务数据
const loadedTaskData = {};

/**
 * 切换行展开/折叠状态
 */
function toggleRowExpand(historyId, event) {
    const row = document.querySelector(`tr[data-history-id="${historyId}"]`);
    const detailRow = document.querySelector(`tr[data-detail-for="${historyId}"]`);

    if (!row || !detailRow) {
        return;
    }

    const isExpanded = row.classList.contains('expanded');

    if (isExpanded) {
        // 折叠
        row.classList.remove('expanded');
        detailRow.classList.remove('visible');
    } else {
        // 展开
        row.classList.add('expanded');
        detailRow.classList.add('visible');

        // 如果还没有加载过任务数据，则加载
        if (!loadedTaskData[historyId]) {
            loadTaskHistory(historyId);
        }
    }
}

/**
 * 加载任务历史数据
 */
function loadTaskHistory(historyId) {
    const container = document.getElementById(`taskList-${historyId}`);

    if (!container) {
        return;
    }

    // 显示加载状态
    container.innerHTML = `
        <div class="task-list-loading">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">加载任务列表...</span>
        </div>
    `;

    // 获取任务数据
    fetch(`/api/history/${historyId}/tasks`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadedTaskData[historyId] = data.data.tasks;
                renderTaskList(historyId, data.data.tasks);
            } else {
                container.innerHTML = `
                    <div class="task-list-error">
                        <i class="bi bi-exclamation-triangle"></i>
                        加载失败: ${data.error || '未知错误'}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('加载任务历史失败:', error);
            container.innerHTML = `
                <div class="task-list-error">
                    <i class="bi bi-exclamation-triangle"></i>
                    加载失败: ${error.message}
                </div>
            `;
        });
}

/**
 * 渲染任务列表
 */
function renderTaskList(historyId, tasks) {
    const container = document.getElementById(`taskList-${historyId}`);

    if (!container) {
        return;
    }

    if (!tasks || tasks.length === 0) {
        container.innerHTML = `
            <div class="task-list-empty">
                <i class="bi bi-inbox"></i>
                <span>暂无任务记录</span>
            </div>
        `;
        return;
    }

    let html = `
        <div class="task-list-header">
            <div class="task-list-title">
                <i class="bi bi-list-task"></i>
                任务列表
                <span class="task-list-count">${tasks.length}</span>
            </div>
        </div>
    `;

    tasks.forEach(task => {
        html += renderTaskItem(task);
    });

    container.innerHTML = html;
}

/**
 * 渲染单个任务项
 */
function renderTaskItem(task) {
    const statusClass = task.status || 'pending';
    const statusText = {
        'pending': '等待中',
        'running': '运行中',
        'completed': '已完成',
        'failed': '失败'
    }[statusClass] || statusClass;

    // 格式化时间
    const startTime = task.start_time ? formatDateTime(task.start_time) : '-';
    const endTime = task.end_time ? formatDateTime(task.end_time) : '-';

    // 格式化运行时长
    let durationText = '-';
    if (task.duration !== null && task.duration !== undefined) {
        durationText = formatDurationFromSeconds(Math.round(task.duration));
    }

    // 进度条
    let progressHtml = '';
    if (task.progress !== null && task.progress !== undefined) {
        progressHtml = `
            <div class="task-item-progress">
                <div class="task-progress-mini">
                    <div class="task-progress-mini-fill" style="width: ${task.progress}%"></div>
                </div>
                <span>${task.progress}%</span>
                ${task.progress_message ? `<span class="text-muted">${escapeHtml(task.progress_message)}</span>` : ''}
            </div>
        `;
    }

    return `
        <div class="task-item">
            <div class="task-item-status ${statusClass}"></div>
            <div class="task-item-content">
                <div class="task-item-name">
                    <i class="bi bi-gear-fill text-muted"></i>
                    <span>${escapeHtml(task.name)}</span>
                    <span class="status-badge ${statusClass}" style="font-size: 0.7rem;">${statusText}</span>
                </div>
                <div class="task-item-meta">
                    <div class="task-item-time">
                        <i class="bi bi-calendar3"></i>
                        <span>开始: ${startTime}</span>
                    </div>
                    <div class="task-item-time">
                        <i class="bi bi-calendar-check"></i>
                        <span>结束: ${endTime}</span>
                    </div>
                    <div class="task-item-duration">
                        <i class="bi bi-clock"></i>
                        <span>${durationText}</span>
                    </div>
                    ${progressHtml}
                </div>
            </div>
            <div class="task-item-actions">
                ${task.has_input ? `
                    <button class="task-action-btn" data-tooltip="查看输入" onclick="viewTaskData(${task.id}, 'input')">
                        <i class="bi bi-box-arrow-in-down-right"></i>
                    </button>
                ` : ''}
                ${task.has_output ? `
                    <button class="task-action-btn" data-tooltip="查看输出" onclick="viewTaskData(${task.id}, 'output')">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `;
}

/**
 * 格式化日期时间
 */
function formatDateTime(isoString) {
    if (!isoString) return '-';

    const date = new Date(isoString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');

    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

/**
 * 查看任务数据（输入/输出）
 */
function viewTaskData(taskId, type) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    loadingOverlay.style.display = 'flex';

    fetch(`/api/tasks/${taskId}/data`)
        .then(response => response.json())
        .then(data => {
            loadingOverlay.style.display = 'none';

            if (!data.success) {
                showNotification('加载失败: ' + (data.error || '未知错误'), 'error');
                return;
            }

            const task = data.data;
            const dataType = type === 'input' ? '输入数据' : '输出数据';
            const dataContent = type === 'input' ? task.input_data : task.output_data;

            if (!dataContent) {
                showNotification(`该任务没有${dataType}`, 'warning');
                return;
            }

            // 设置模态框标题
            const title = `任务 #${taskId} - ${task.name} - ${dataType}`;
            document.querySelector('#dataModal .modal-title').textContent = title;

            // 设置隐藏的文本区域用于复制
            const jsonStr = typeof dataContent === 'string'
                ? dataContent
                : JSON.stringify(dataContent, null, 2);
            document.getElementById('modal-data-textarea').value = jsonStr;

            // 创建JSON Viewer实例并渲染数据
            const viewer = new JSONViewer({
                rootCollapsable: true,
                clickableUrls: true,
                bigNumbers: false
            });
            const viewerElement = document.getElementById('modal-data-viewer');

            // 如果是字符串，尝试解析为JSON
            const displayData = typeof dataContent === 'string'
                ? jsonStr
                : dataContent;

            try {
                const parsedData = typeof displayData === 'string'
                    ? JSON.parse(displayData)
                    : displayData;
                viewer.render(viewerElement, parsedData);
            } catch (e) {
                // 如果解析失败，直接显示字符串
                viewerElement.innerHTML = `<pre class="bg-light p-3 rounded"><code>${escapeHtml(jsonStr)}</code></pre>`;
            }

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('dataModal'));
            modal.show();

        })
        .catch(error => {
            loadingOverlay.style.display = 'none';
            console.error('加载任务数据失败:', error);
            showNotification('加载失败: ' + error.message, 'error');
        });
}

/**
 * 刷新已展开的任务列表
 */
function refreshExpandedTaskLists() {
    Object.keys(loadedTaskData).forEach(historyId => {
        const row = document.querySelector(`tr[data-history-id="${historyId}"]`);
        if (row && row.classList.contains('expanded')) {
            loadTaskHistory(historyId);
        }
    });
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 添加加载动画
    const sections = document.querySelectorAll('.animate-fade-in');
    sections.forEach((section, index) => {
        section.style.animationDelay = `${index * 0.1}s`;
    });

    // 初始化运行中任务的实时时长更新
    initRunningDurationUpdate();

    // 初始化自动刷新
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    if (autoRefreshToggle) {
        autoRefreshToggle.addEventListener('change', toggleAutoRefresh);

        // 从 localStorage 读取自动刷新状态
        const savedRefreshState = localStorage.getItem(AUTO_REFRESH_STORAGE_KEY);
        if (savedRefreshState === 'true') {
            autoRefreshToggle.checked = true;
            startAutoRefresh();
        } else {
            updateAutoRefreshStatus();
        }
    }

    // 初始化触发按钮
    const confirmTriggerBtn = document.getElementById('confirmTrigger');
    if (confirmTriggerBtn) {
        confirmTriggerBtn.addEventListener('click', confirmTriggerFlow);
    }

    // 为参数输入框添加实时验证
    const flowParamsInput = document.getElementById('flowParams');
    if (flowParamsInput) {
        flowParamsInput.addEventListener('input', function() {
            const text = this.value.trim();
            if (text) {
                const validation = validateJSON(text);
                if (!validation.valid) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    // 为重试按钮添加事件监听器
    const retryButtons = document.querySelectorAll('.retry-btn');
    retryButtons.forEach(button => {
        button.addEventListener('click', handleRetryButtonClick);
    });

    // 为数据预览按钮添加事件监听器
    const viewDataButtons = document.querySelectorAll('.view-data-btn');
    viewDataButtons.forEach(button => {
        button.addEventListener('click', handleDataPreviewClick);
    });

    // 初始化进度轮询
    initProgressPolling();
});

// ========================================
// 任务进度轮询功能
// ========================================

let progressPollingInterval = null;
const FLOW_ID = '{{ flow.id }}';
const POLLING_INTERVAL = 2000;  // 2秒轮询一次

/**
 * 渲染当前任务列内容
 */
function renderCurrentTaskCell(history) {
    // 运行中状态，显示进度
    if (history.status === 'running' && history.running_tasks && history.running_tasks.length > 0) {
        let html = '';
        history.running_tasks.forEach(task => {
            const progress = task.progress;
            const message = task.progress_message;

            html += '<div class="current-task-item">';
            html += '<div class="task-name">';
            html += '<i class="bi bi-gear-fill task-icon running"></i>';
            html += `<span>${escapeHtml(task.name)}</span>`;
            html += '</div>';

            if (progress !== null && progress !== undefined) {
                // 有进度信息，显示进度条
                html += '<div class="task-progress-bar">';
                html += '<div class="task-progress-fill animated" style="width: ' + progress + '%"></div>';
                html += '</div>';
                html += '<div class="task-progress-info">';
                html += `<span class="task-progress-percent">${progress}%</span>`;
                if (message) {
                    html += `<span class="task-progress-message">${escapeHtml(message)}</span>`;
                }
                html += '</div>';
            } else {
                // 无进度信息，显示加载中状态
                html += '<div class="task-running-indicator">';
                html += '<span class="spinner"></span>';
                html += '<span>执行中...</span>';
                html += '</div>';
            }

            html += '</div>';
        });
        return html;
    }
    // 非运行状态，显示最后一个任务
    else if (history.running_tasks && history.running_tasks.length > 0) {
        let html = '';
        history.running_tasks.forEach(task => {
            const status = task.status || history.status;
            const iconClass = status === 'completed' ? 'check-circle-fill' :
                              status === 'failed' ? 'x-circle-fill' : 'gear-fill';

            html += '<div class="current-task-item completed">';
            html += '<div class="task-name">';
            html += `<i class="bi bi-${iconClass} task-icon ${status}"></i>`;
            html += `<span>${escapeHtml(task.name)}</span>`;
            html += '</div>';
            html += '</div>';
        });
        return html;
    } else {
        // 没有任务信息
        return '<span class="no-current-task">-</span>';
    }
}

/**
 * 渲染时间信息列内容
 */
function renderTimeInfoCell(history) {
    const formatDate = (dateStr) => {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        const currentYear = new Date().getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');

        // 当年不显示年份，非当年显示完整日期
        if (date.getFullYear() === currentYear) {
            return `${month}-${day} ${hours}:${minutes}:${seconds}`;
        } else {
            return `${date.getFullYear()}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    };

    let html = '<div class="time-info-cell">';

    // 创建时间
    html += '<div class="time-info-row">';
    html += '<span class="time-label">创建</span>';
    html += `<span class="time-value">${formatDate(history.created_at)}</span>`;
    html += '</div>';

    // 开始时间
    if (history.start_time) {
        html += '<div class="time-info-row">';
        html += '<span class="time-label">开始</span>';
        html += `<span class="time-value">${formatDate(history.start_time)}</span>`;
        html += '</div>';
    }

    // 结束时间
    if (history.end_time) {
        html += '<div class="time-info-row">';
        html += '<span class="time-label">结束</span>';
        html += `<span class="time-value">${formatDate(history.end_time)}</span>`;
        html += '</div>';
    }

    html += '</div>';
    return html;
}

/**
 * 更新所有运行中任务的进度
 */
function updateTaskProgress() {
    const currentTaskCells = document.querySelectorAll('.current-task-cell');
    if (currentTaskCells.length === 0) {
        return;
    }

    // 获取所有历史记录的ID
    const historyIds = Array.from(currentTaskCells).map(cell => parseInt(cell.dataset.historyId));

    // 批量获取进度信息
    fetch(`/api/flows/${FLOW_ID}/history`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.histories) {
                const historiesMap = {};
                data.data.histories.forEach(h => {
                    historiesMap[h.id] = h;
                });

                // 更新每个历史记录的进度
                currentTaskCells.forEach(cell => {
                    const historyId = parseInt(cell.dataset.historyId);
                    const history = historiesMap[historyId];

                    if (history) {
                        // 更新当前任务列
                        cell.innerHTML = renderCurrentTaskCell(history);

                        // 同时更新时间信息列
                        const row = cell.closest('tr');
                        if (row) {
                            const timeInfoCell = row.querySelector('.time-info-cell');
                            if (timeInfoCell && timeInfoCell.parentElement) {
                                timeInfoCell.parentElement.innerHTML = renderTimeInfoCell(history);
                            }
                        }

                        // 更新状态徽章
                        const statusCell = row.querySelector('td:nth-child(4)');
                        if (statusCell && history.status !== statusCell.dataset.originalStatus) {
                            const statusBadge = statusCell.querySelector('.status-badge');
                            if (statusBadge) {
                                statusBadge.className = `status-badge ${history.status}`;
                                const icon = statusBadge.querySelector('i');
                                const text = statusBadge.childNodes[statusBadge.childNodes.length - 1];
                                if (icon) {
                                    icon.className = `bi bi-${history.status === 'pending' ? 'clock' : history.status === 'running' ? 'arrow-repeat' : history.status === 'completed' ? 'check-circle' : history.status === 'failed' ? 'x-circle' : 'question-circle'}`;
                                }
                                if (text && text.nodeType === Node.TEXT_NODE) {
                                    text.textContent = ` ${history.status === 'pending' ? '等待中' : history.status === 'running' ? '运行中' : history.status === 'completed' ? '已完成' : history.status === 'failed' ? '失败' : history.status}`;
                                }
                            }
                        }
                    }
                });

                // 检查是否还有运行中的任务
                checkAndStopPolling(data.data.histories);
            }
        })
        .catch(error => {
            console.error('更新任务进度失败:', error);
        });
}

/**
 * 检查是否有运行中的任务，如果没有则停止轮询
 */
function checkAndStopPolling(histories) {
    const hasRunning = histories && histories.some(h => h.status === 'running');

    if (!hasRunning && progressPollingInterval) {
        // 没有运行中的任务，停止轮询
        clearInterval(progressPollingInterval);
        progressPollingInterval = null;
        console.log('所有任务已完成，停止进度轮询');
    } else if (hasRunning && !progressPollingInterval) {
        // 有运行中的任务但轮询已停止，重新启动
        startProgressPolling();
    }
}

/**
 * 启动进度轮询
 */
function startProgressPolling() {
    if (progressPollingInterval) {
        clearInterval(progressPollingInterval);
    }

    progressPollingInterval = setInterval(updateTaskProgress, POLLING_INTERVAL);
    console.log('启动进度轮询');
}

/**
 * 初始化进度轮询
 */
function initProgressPolling() {
    // 首次加载进度信息
    updateTaskProgress();

    // 检查是否有运行中的任务
    let hasRunning = false;

    // 通过状态列检查是否有运行中的任务
    const statusBadges = document.querySelectorAll('.status-badge.running');
    if (statusBadges.length > 0) {
        hasRunning = true;
    }

    if (hasRunning) {
        startProgressPolling();
    }

    // 页面卸载时清除轮询
    window.addEventListener('beforeunload', () => {
        if (progressPollingInterval) {
            clearInterval(progressPollingInterval);
        }
    });
}
</script>
{% endblock %}